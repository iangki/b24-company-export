<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Bitrix24 Export</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  </head>
  <body>
    <div id="app">
      <button :disabled="loading" @click="runExport">
        {{ loading ? "Exporting..." : "Export 10,000 companies" }}
      </button>

      <p v-if="error" style="color:#b00">{{ error }}</p>

      <div v-if="result">
        <p>Count: {{ result.count }}</p>
        <p><a :href="result.downloadUrl" target="_blank">Download companies.json</a></p>

        <ul>
          <li v-for="c in result.preview" :key="c.ID">{{ c.ID }} â€” {{ c.TITLE }}</li>
        </ul>
      </div>
    </div>

    <script>
      const { createApp } = Vue;

      createApp({
        data: () => ({ loading: false, error: "", result: null }),
        methods: {
          async runExport() {
            this.loading = true;
            this.error = "";
            this.result = null;

            try {
              const r = await fetch("/api/export", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ limit: 10000 })
              });

              const data = await r.json();
              if (!data.ok) throw new Error(data.error || "Export failed");
              this.result = data;
            } catch (e) {
              this.error = String(e.message || e);
            } finally {
              this.loading = false;
            }
          }
        }
      }).mount("#app");
    </script>
  </body>
</html>